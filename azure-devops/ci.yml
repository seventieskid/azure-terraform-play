trigger:
- master

jobs:
- job: terraform_test
  workspace:
    clean: all
  pool: azuron-devops-agents
  steps:
  - task: Docker@2
    displayName: Login to ACR
    inputs:
      command: login
      containerRegistry: azuron-sc-service-principal
  - task: Bash@3
    displayName: Bring Azure identity onto agent
    inputs:
      targetType: 'inline'
      script: |
        mkdir $(Pipeline.Workspace)/s/.azure-for-docker
        cd $(Pipeline.Workspace)/s/.azure-for-docker
        AZURE_CONFIG_DIR=$(Pipeline.Workspace)/s/.azure-for-docker az login --identity --username ba68b5e0-f6a9-490e-be3b-52be81e26eed
        ls -aRl $(Pipeline.Workspace)/s/.azure-for-docker
  - task: Bash@3
    displayName: Run custom container
    inputs:
      targetType: 'inline'
      script: |
        docker run -w /tmp/codebase \
                  --network host \
                  -e AZURE_CONFIG_DIR=/root/.azure \
                  -v $(Pipeline.Workspace)/s:/tmp/codebase:rw \
                  -v  $(Pipeline.Workspace)/s/.azure-for-docker:/root/.azure:rw \
                  azuron.azurecr.io/azure-cli-terraform:0.0.2 \
                  /tmp/codebase/terraform-init-apply.sh